<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Makine Bildirimleri - G√ºndoƒüdu Tekstil</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0c1222;
      --bg-card: #151d30;
      --border-color: #2a3a5c;
      --accent: #d4a853;
      --accent-light: #f0c970;
      --accent-glow: rgba(212, 168, 83, 0.3);
      --text-primary: #ffffff;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #f59e0b;
      --warning-bg: rgba(245, 158, 11, 0.15);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-dark);
      min-height: 100vh;
      color: var(--text-primary);
    }

    /* Header */
    .header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-color);
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--accent), var(--accent-light));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .header-title h1 {
      font-size: 1.3rem;
      font-weight: 600;
    }

    .header-title p {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .back-btn {
      padding: 10px 20px;
      background: var(--bg-dark);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .back-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Main Content */
    .main-content {
      padding: 30px 40px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Filters Section */
    .filters-section {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filter-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .filter-select {
      padding: 8px 12px;
      background: var(--bg-dark);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 150px;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .btn-refresh {
      padding: 8px 16px;
      background: linear-gradient(135deg, var(--accent), var(--accent-light));
      border: none;
      border-radius: 8px;
      color: var(--bg-dark);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }

    .btn-refresh:hover {
      box-shadow: 0 5px 20px var(--accent-glow);
      transform: translateY(-1px);
    }

    .btn-refresh:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Table Section */
    .table-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      overflow: hidden;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: rgba(212, 168, 83, 0.1);
    }

    th {
      padding: 16px 20px;
      text-align: left;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
    }

    td {
      padding: 14px 20px;
      font-size: 0.9rem;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-color);
    }

    tbody tr {
      transition: background 0.2s ease;
    }

    tbody tr:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .btn-detail {
      padding: 6px 12px;
      background: transparent;
      border: 1px solid var(--accent);
      border-radius: 6px;
      color: var(--accent);
      font-family: inherit;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-detail:hover {
      background: var(--accent);
      color: var(--bg-dark);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-badge.acik {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
    }

    .status-badge.islemde {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
    }

    .status-badge.cozuldu {
      background: rgba(34, 197, 94, 0.15);
      color: var(--success);
    }

    .status-badge.iptal {
      background: rgba(148, 163, 184, 0.15);
      color: var(--text-secondary);
    }

    .priority-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .priority-badge.dusuk {
      background: rgba(34, 197, 94, 0.15);
      color: var(--success);
    }

    .priority-badge.orta {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
    }

    .priority-badge.yuksek {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
    }

    .priority-badge.kritik {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .loading-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .spinner {
      border: 3px solid var(--border-color);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 1.2rem;
      color: var(--text-primary);
    }

    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: rgba(148, 163, 184, 0.15);
      color: #ffffff;
    }

    .modal-body {
      padding: 24px;
    }

    .detail-group {
      margin-bottom: 20px;
    }

    .detail-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 6px;
      font-weight: 500;
    }

    .detail-value {
      font-size: 0.95rem;
      color: var(--text-primary);
      line-height: 1.6;
    }

    .detail-description {
      background: rgba(15, 23, 42, 0.5);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .modal-footer {
      padding: 20px 24px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .status-update-group {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .status-update-select {
      padding: 8px 12px;
      background: var(--bg-dark);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      flex: 1;
      max-width: 200px;
    }

    .status-update-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .btn-save {
      padding: 8px 16px;
      background: linear-gradient(135deg, var(--accent), var(--accent-light));
      border: none;
      border-radius: 8px;
      color: var(--bg-dark);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-save:hover:not(:disabled) {
      box-shadow: 0 5px 20px var(--accent-glow);
      transform: translateY(-1px);
    }

    .btn-save:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .toast {
      position: fixed;
      right: 20px;
      bottom: 20px;
      background: #022c22;
      color: #bbf7d0;
      padding: 14px 18px;
      border-radius: 10px;
      font-size: 0.9rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 1100;
      max-width: 300px;
    }

    .toast.show {
      display: block;
      animation: slideIn 0.3s ease;
    }

    .toast.error {
      background: #2d1b1b;
      color: #fca5a5;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

     /* Charts Row Top */
     .charts-row-top {
       display: grid;
       grid-template-columns: repeat(2, 1fr);
       gap: 25px;
       margin-bottom: 25px;
     }

     @media (max-width: 768px) {
       .charts-row-top {
         grid-template-columns: 1fr;
       }
     }

     /* Chart Card */
     .chart-card {
       background: var(--bg-card);
       border: 1px solid var(--border-color);
       border-radius: 16px;
       padding: 24px;
       box-shadow: 0 10px 25px rgba(0,0,0,0.25);
     }

     .chart-card.chart-full-width {
       margin-bottom: 25px;
     }

     .chart-card h3 {
       font-size: 1.2rem;
       margin-bottom: 4px;
       color: var(--text-primary);
     }

     .chart-subtitle {
       font-size: 0.85rem;
       color: var(--text-secondary);
       margin-bottom: 0;
     }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      padding: 20px;
      border-top: 1px solid var(--border-color);
    }

    .pagination-btn {
      padding: 8px 16px;
      background: var(--bg-dark);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 40px;
    }

    .pagination-btn:hover:not(:disabled):not(.active) {
      border-color: var(--accent);
      color: var(--accent);
    }

    .pagination-btn.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-light));
      border-color: var(--accent);
      color: var(--bg-dark);
      font-weight: 600;
    }

    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* KPI Cards */
    #kpi-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .kpi-card {
      background: rgba(212, 168, 83, 0.1);
      border: 1px solid rgba(212, 168, 83, 0.3);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s ease;
    }

    .kpi-card:hover {
      border-color: var(--accent);
      background: rgba(212, 168, 83, 0.15);
    }

    .kpi-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .kpi-value {
      font-size: 1.8rem;
      font-weight: 600;
      color: var(--accent);
    }

    /* Recent Reports Cards */
    .recent-report-card {
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }

    .recent-report-card:hover {
      border-color: var(--accent);
      background: rgba(15, 23, 42, 0.7);
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
      }

      .header-right {
        flex-direction: column;
      }

      .main-content {
        padding: 20px;
      }

      .filters-section {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-group {
        width: 100%;
      }

      .filter-select {
        width: 100%;
      }

      .btn-refresh {
        margin-left: 0;
        width: 100%;
        justify-content: center;
      }

      .table-container {
        overflow-x: scroll;
      }

      table {
        font-size: 0.8rem;
      }

      th, td {
        padding: 10px 12px;
      }

      #kpi-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <div class="logo-icon">üëî</div>
      <div class="header-title">
        <h1>Makine Bildirimleri</h1>
        <p>G√ºndoƒüdu Tekstil Y√∂netim Paneli</p>
      </div>
    </div>
    <div class="header-right">
      <a href="/admin-dashboard.html" class="back-btn">
        ‚Üê Admin Paneline D√∂n
      </a>
    </div>
  </header>

  <main class="main-content">
    <!-- Top Row: Two Charts Side-by-Side -->
    <div class="charts-row-top">
      <!-- Left Chart: Machine Distribution -->
      <div class="chart-card">
        <h3>üìä Makine Arƒ±za Daƒüƒ±lƒ±mƒ±</h3>
        <p class="chart-subtitle">Son 3 ay (bildirim sayƒ±sƒ±)</p>
        <div style="position: relative; height: 300px; margin-top: 20px;">
          <canvas id="fault-distribution-chart"></canvas>
          <div id="chart-empty" style="display: none; padding: 40px; text-align: center; color: var(--text-secondary);">
            Veri yok
          </div>
        </div>
      </div>

      <!-- Right Chart: Fault Type Distribution -->
      <div class="chart-card">
        <h3>üìä Arƒ±za T√ºr√º Daƒüƒ±lƒ±mƒ±</h3>
        <p class="chart-subtitle">Son 3 ay (bildirim sayƒ±sƒ±)</p>
        <div style="position: relative; height: 300px; margin-top: 20px;">
          <canvas id="fault-type-chart"></canvas>
          <div id="chart-type-empty" style="display: none; padding: 40px; text-align: center; color: var(--text-secondary);">
            Veri yok
          </div>
        </div>
      </div>
    </div>

    <!-- Second Row: Personnel-Driven List View -->
    <div class="chart-card chart-full-width">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
        <div>
          <h3>üë∑ Personel Bazlƒ± Arƒ±za Bildirimleri</h3>
          <p class="chart-subtitle">Son 3 ay verileri</p>
        </div>
        <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
          <div class="filter-group" style="margin: 0;">
            <label class="filter-label">Zaman Aralƒ±ƒüƒ±</label>
            <select id="time-range-select" class="filter-select" style="min-width: 120px;">
              <option value="3" selected>3 Ay</option>
              <option value="1">1 Ay</option>
            </select>
          </div>
          <div class="filter-group" style="margin: 0;">
            <label class="filter-label">Personel</label>
            <select id="personnel-select" class="filter-select" style="min-width: 200px;">
              <option value="ALL">T√ºm√º</option>
            </select>
          </div>
        </div>
      </div>

      <!-- KPI Cards -->
      <div id="kpi-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
        <div style="background: rgba(212, 168, 83, 0.1); border: 1px solid rgba(212, 168, 83, 0.3); border-radius: 12px; padding: 16px;">
          <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">Toplam Bildirim</div>
          <div id="kpi-total-reports" style="font-size: 1.8rem; font-weight: 600; color: var(--accent);">--</div>
        </div>
        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 16px;">
          <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">Farklƒ± Makine Sayƒ±sƒ±</div>
          <div id="kpi-unique-machines" style="font-size: 1.8rem; font-weight: 600; color: #60a5fa;">--</div>
        </div>
      </div>

      <!-- Machine Breakdown Table -->
      <div style="margin-bottom: 25px;">
        <h4 style="font-size: 1rem; margin-bottom: 15px; color: var(--text-primary);">Makine Daƒüƒ±lƒ±mƒ±</h4>
        <div id="machine-breakdown-container">
          <div class="loading-state">
            <div class="spinner"></div>
            <p>Y√ºkleniyor...</p>
          </div>
        </div>
      </div>

      <!-- Recent Reports List -->
      <div>
        <h4 style="font-size: 1rem; margin-bottom: 15px; color: var(--text-primary);">Son Bildirimler (Son 50)</h4>
        <div id="recent-reports-container">
          <div class="loading-state">
            <div class="spinner"></div>
            <p>Y√ºkleniyor...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
      <div class="filter-group">
        <label class="filter-label">Durum</label>
        <select id="filter-status" class="filter-select">
          <option value="All">T√ºm√º</option>
          <option value="A√ßƒ±k">A√ßƒ±k</option>
          <option value="ƒ∞≈ülemde">ƒ∞≈ülemde</option>
          <option value="√á√∂z√ºld√º">√á√∂z√ºld√º</option>
          <option value="ƒ∞ptal">ƒ∞ptal</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">√ñncelik</label>
        <select id="filter-priority" class="filter-select">
          <option value="All">T√ºm√º</option>
          <option value="D√º≈ü√ºk">D√º≈ü√ºk</option>
          <option value="Orta">Orta</option>
          <option value="Y√ºksek">Y√ºksek</option>
          <option value="Kritik">Kritik</option>
        </select>
      </div>
      <button class="btn-refresh" id="btn-refresh" onclick="loadReports(1)">
        üîÑ Yenile
      </button>
    </div>

    <div class="table-card">
      <div class="table-container">
        <div id="reports-container">
          <div class="loading-state">
            <div class="spinner"></div>
            <p>Y√ºkleniyor...</p>
          </div>
        </div>
      </div>
      <!-- Pagination -->
      <div id="pagination-container" class="pagination" style="display: none;">
      </div>
    </div>
  </main>

  <!-- Detail Modal -->
  <div class="modal" id="detail-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Bildirim Detayƒ±</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modal-body">
        <!-- Content will be populated by JavaScript -->
      </div>
      <div class="modal-footer">
        <div class="status-update-group">
          <label class="filter-label" style="margin: 0;">Durum G√ºncelle:</label>
          <select id="status-update-select" class="status-update-select">
            <option value="A√ßƒ±k">A√ßƒ±k</option>
            <option value="ƒ∞≈ülemde">ƒ∞≈ülemde</option>
            <option value="√á√∂z√ºld√º">√á√∂z√ºld√º</option>
            <option value="ƒ∞ptal">ƒ∞ptal</option>
          </select>
          <button class="btn-save" id="btn-save-status" onclick="updateStatus()">
            Kaydet
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
     let currentReportId = null;
     let allReports = [];
     let currentPage = 1;
     let paginationInfo = null;
     let distributionChart = null;
     let typeChart = null;
     let currentMonths = 3;
     let currentPersonnelId = 'ALL'; // Single source of truth - always a string

    // Show toast message
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type === 'error' ? 'error' : ''} show`;
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Get status badge class
    function getStatusClass(status) {
      const statusMap = {
        'A√ßƒ±k': 'acik',
        'ƒ∞≈ülemde': 'islemde',
        '√á√∂z√ºld√º': 'cozuldu',
        'ƒ∞ptal': 'iptal'
      };
      return statusMap[status] || 'acik';
    }

    // Get priority badge class
    function getPriorityClass(priority) {
      const priorityMap = {
        'D√º≈ü√ºk': 'dusuk',
        'Orta': 'orta',
        'Y√ºksek': 'yuksek',
        'Kritik': 'kritik'
      };
      return priorityMap[priority] || 'orta';
    }

    // Format date
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('tr-TR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Load reports with pagination
    async function loadReports(page = 1) {
      const container = document.getElementById('reports-container');
      const refreshBtn = document.getElementById('btn-refresh');
      
      refreshBtn.disabled = true;
      container.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Y√ºkleniyor...</p></div>';

      try {
        const status = document.getElementById('filter-status').value;
        const priority = document.getElementById('filter-priority').value;
        
        const params = new URLSearchParams();
        if (status !== 'All') params.append('status', status);
        if (priority !== 'All') params.append('priority', priority);
        params.append('page', page.toString());
        params.append('limit', '20');

        const res = await fetch(`/api/admin/machine-fault-reports?${params.toString()}`);
        if (!res.ok) throw new Error('Bildirimler y√ºklenemedi');
        
        const result = await res.json();
        
        // Handle both old format (array) and new format (object with data and pagination)
        let reports, pagination;
        if (Array.isArray(result)) {
          reports = result;
          pagination = null;
        } else {
          reports = result.data || [];
          pagination = result.pagination || null;
        }
        
        allReports = reports;
        paginationInfo = pagination;
        currentPage = page;

        if (!reports || reports.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìã</div>
              <p>Hen√ºz makine arƒ±za bildirimi bulunmuyor.</p>
            </div>
          `;
          renderPagination();
          return;
        }

        const table = document.createElement('table');
        table.innerHTML = `
          <thead>
            <tr>
              <th>Tarih</th>
              <th>Makine</th>
              <th>T√ºr</th>
              <th>Personel</th>
              <th>√ñncelik</th>
              <th>Durum</th>
              <th>Ba≈ülƒ±k</th>
              <th>ƒ∞≈ülem</th>
            </tr>
          </thead>
          <tbody>
            ${reports.map(report => {
              const dateStr = formatDate(report.created_at);
              const statusClass = getStatusClass(report.status);
              const priorityClass = getPriorityClass(report.priority);
              
              return `
                <tr>
                  <td>${dateStr}</td>
                  <td>${report.makine_adi || '-'}</td>
                  <td>${report.fault_type}</td>
                  <td>${report.personel_adsoyad || '-'}</td>
                  <td><span class="priority-badge ${priorityClass}">${report.priority}</span></td>
                  <td><span class="status-badge ${statusClass}">${report.status}</span></td>
                  <td>${report.title}</td>
                  <td>
                    <button class="btn-detail" onclick="showDetail(${report.report_id})">
                      Detay
                    </button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        `;
        
        container.innerHTML = '';
        container.appendChild(table);
        
        renderPagination();
      } catch (err) {
        console.error('Reports load error:', err);
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ö†Ô∏è</div>
            <p>Veriler y√ºklenemedi.</p>
          </div>
        `;
        showToast('Veriler y√ºklenirken hata olu≈ütu', 'error');
        renderPagination();
      } finally {
        refreshBtn.disabled = false;
      }
    }

    // Render pagination controls
    function renderPagination() {
      const container = document.getElementById('pagination-container');
      if (!paginationInfo || paginationInfo.totalPages <= 1) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'flex';
      const { page, totalPages } = paginationInfo;
      
      let html = '';
      
      // Previous button
      html += `<button class="pagination-btn" ${page === 1 ? 'disabled' : ''} onclick="loadReports(${page - 1})">‚Äπ</button>`;
      
      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= page - 1 && i <= page + 1)) {
          html += `<button class="pagination-btn ${i === page ? 'active' : ''}" onclick="loadReports(${i})">${i}</button>`;
        } else if (i === page - 2 || i === page + 2) {
          html += `<span style="color: var(--text-secondary); padding: 0 4px;">...</span>`;
        }
      }
      
      // Next button
      html += `<button class="pagination-btn" ${page === totalPages ? 'disabled' : ''} onclick="loadReports(${page + 1})">‚Ä∫</button>`;
      
      container.innerHTML = html;
    }

     // Load distribution chart
     async function loadDistributionChart() {
       const canvas = document.getElementById('fault-distribution-chart');
       const emptyDiv = document.getElementById('chart-empty');
       
       try {
         const res = await fetch('/api/admin/machine-faults/distribution?months=3');
         if (!res.ok) throw new Error('Chart verisi y√ºklenemedi');
         
         const result = await res.json();
         const data = result.data || [];
         console.log("machine-distribution data", data);
         
         if (data.length === 0) {
           canvas.style.display = 'none';
           emptyDiv.style.display = 'block';
           emptyDiv.textContent = 'Veri yok (son 3 ay filtresi nedeniyle bo≈ü olabilir).';
           return;
         }
         
         canvas.style.display = 'block';
         emptyDiv.style.display = 'none';
         
         // Destroy existing chart if it exists
         if (distributionChart) {
           distributionChart.destroy();
         }
         
         const ctx = canvas.getContext('2d');
         distributionChart = new Chart(ctx, {
           type: 'bar',
           data: {
             labels: data.map(item => item.label),
             datasets: [{
               label: 'Arƒ±za Sayƒ±sƒ±',
               data: data.map(item => item.value),
               backgroundColor: 'rgba(212, 168, 83, 0.6)',
               borderColor: 'rgba(212, 168, 83, 1)',
               borderWidth: 1
             }]
           },
           options: {
             indexAxis: 'y',
             responsive: true,
             maintainAspectRatio: false,
             plugins: {
               legend: {
                 display: false
               },
               tooltip: {
                 backgroundColor: 'rgba(21, 29, 48, 0.95)',
                 titleColor: '#ffffff',
                 bodyColor: '#d4a853',
                 borderColor: '#2a3a5c',
                 borderWidth: 1
               }
             },
             scales: {
               x: {
                 beginAtZero: true,
                 ticks: {
                   color: '#94a3b8',
                   stepSize: 1
                 },
                 grid: {
                   color: 'rgba(42, 58, 92, 0.5)'
                 }
               },
               y: {
                 ticks: {
                   color: '#94a3b8'
                 },
                 grid: {
                   color: 'rgba(42, 58, 92, 0.5)'
                 }
               }
             }
           }
         });
       } catch (err) {
         console.error('Chart load error:', err);
         canvas.style.display = 'none';
         emptyDiv.style.display = 'block';
         emptyDiv.textContent = 'Veri y√ºklenirken hata olu≈ütu.';
       }
     }

     // Load fault type distribution chart
     async function loadTypeDistributionChart() {
       const canvas = document.getElementById('fault-type-chart');
       const emptyDiv = document.getElementById('chart-type-empty');
       
       try {
         const res = await fetch('/api/admin/machine-faults/type-distribution?months=3');
         if (!res.ok) throw new Error('Chart verisi y√ºklenemedi');
         
         const result = await res.json();
         const data = result.data || [];
         console.log("type-distribution data", data);
         
         if (data.length === 0) {
           canvas.style.display = 'none';
           emptyDiv.style.display = 'block';
           emptyDiv.textContent = 'Veri yok (son 3 ay filtresi nedeniyle bo≈ü olabilir).';
           return;
         }
         
         canvas.style.display = 'block';
         emptyDiv.style.display = 'none';
         
         // Destroy existing chart if it exists
         if (typeChart) {
           typeChart.destroy();
         }
         
         const ctx = canvas.getContext('2d');
         
         // Color palette for doughnut chart
         const colors = [
           'rgba(212, 168, 83, 0.8)',
           'rgba(69, 176, 136, 0.8)',
           'rgba(59, 130, 246, 0.8)',
           'rgba(245, 158, 11, 0.8)',
           'rgba(239, 68, 68, 0.8)'
         ];
         
         typeChart = new Chart(ctx, {
           type: 'doughnut',
           data: {
             labels: data.map(item => item.label),
             datasets: [{
               label: 'Arƒ±za Sayƒ±sƒ±',
               data: data.map(item => item.value),
               backgroundColor: colors.slice(0, data.length),
               borderColor: 'rgba(21, 29, 48, 0.8)',
               borderWidth: 2
             }]
           },
           options: {
             responsive: true,
             maintainAspectRatio: false,
             plugins: {
               legend: {
                 position: 'bottom',
                 labels: {
                   color: '#94a3b8',
                   padding: 15,
                   font: {
                     size: 12
                   }
                 }
               },
               tooltip: {
                 backgroundColor: 'rgba(21, 29, 48, 0.95)',
                 titleColor: '#ffffff',
                 bodyColor: '#d4a853',
                 borderColor: '#2a3a5c',
                 borderWidth: 1
               }
             }
           }
         });
       } catch (err) {
         console.error('Type chart load error:', err);
         canvas.style.display = 'none';
         emptyDiv.style.display = 'block';
         emptyDiv.textContent = 'Veri y√ºklenirken hata olu≈ütu.';
       }
     }

     // Load personnel summary (for selector and KPIs)
     async function loadPersonnelSummary() {
       try {
         const res = await fetch(`/api/machine-fault/summary?months=${currentMonths}`);
         if (!res.ok) throw new Error('√ñzet veriler y√ºklenemedi');
         
         const result = await res.json();
         if (!result.success) throw new Error(result.error || 'Veri alƒ±namadƒ±');
         
         // Preserve current selection before rebuilding options
         const personnelSelect = document.getElementById('personnel-select');
         const preservedValue = currentPersonnelId || 'ALL';
         
         // Populate personnel selector
         personnelSelect.innerHTML = '<option value="ALL">T√ºm√º</option>';
         
         if (result.personnel && result.personnel.length > 0) {
           result.personnel.forEach(person => {
             const option = document.createElement('option');
             // Use string value for consistency
             option.value = String(person.personel_id);
             option.textContent = `${person.personel_ad_soyad} (${person.total_reports} bildirim)`;
             personnelSelect.appendChild(option);
           });
         }
         
         // Restore the preserved selection (convert to string for comparison)
         const valueToSet = preservedValue === 'ALL' ? 'ALL' : String(preservedValue);
         // Only set if the option exists
         if (valueToSet === 'ALL' || Array.from(personnelSelect.options).some(opt => opt.value === valueToSet)) {
           personnelSelect.value = valueToSet;
           // Sync state with select value
           currentPersonnelId = personnelSelect.value;
         } else {
           // If preserved value doesn't exist, fall back to ALL
           personnelSelect.value = 'ALL';
           currentPersonnelId = 'ALL';
         }
         
         // Update KPIs based on selected personnel
         updateKPIs(result, currentPersonnelId);
         
         return result; // Return for chaining
       } catch (err) {
         console.error('Personnel summary load error:', err);
         showToast('√ñzet veriler y√ºklenirken hata olu≈ütu', 'error');
         throw err;
       }
     }

     // Update KPI values
     function updateKPIs(summaryData, selectedPersonnelId) {
       const totalReportsEl = document.getElementById('kpi-total-reports');
       const uniqueMachinesEl = document.getElementById('kpi-unique-machines');
       
       // Normalize selectedPersonnelId to string for comparison
       const selectedId = String(selectedPersonnelId || 'ALL');
       
       if (selectedId === 'ALL') {
         totalReportsEl.textContent = summaryData.overall.total_reports || 0;
         uniqueMachinesEl.textContent = summaryData.overall.unique_machines || 0;
       } else {
         // Convert to number for comparison with personel_id
         const personIdNum = parseInt(selectedId, 10);
         const person = summaryData.personnel.find(p => p.personel_id === personIdNum);
         if (person) {
           totalReportsEl.textContent = person.total_reports || 0;
           uniqueMachinesEl.textContent = person.unique_machines || 0;
         } else {
           totalReportsEl.textContent = '0';
           uniqueMachinesEl.textContent = '0';
         }
       }
     }

     // Load machine breakdown and recent reports
     async function loadBreakdown() {
       const breakdownContainer = document.getElementById('machine-breakdown-container');
       const recentContainer = document.getElementById('recent-reports-container');
       
       breakdownContainer.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Y√ºkleniyor...</p></div>';
       recentContainer.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Y√ºkleniyor...</p></div>';
       
       try {
         // Ensure personel_id is properly formatted (string "ALL" or numeric string)
         const personelIdParam = currentPersonnelId === 'ALL' ? 'ALL' : String(currentPersonnelId);
         const res = await fetch(`/api/machine-fault/breakdown?months=${currentMonths}&personel_id=${personelIdParam}`);
         if (!res.ok) throw new Error('Detay veriler y√ºklenemedi');
         
         const result = await res.json();
         if (!result.success) throw new Error(result.error || 'Veri alƒ±namadƒ±');
         
         // Render machine breakdown table
         renderMachineBreakdown(result.machine_breakdown || []);
         
         // Render recent reports list
         renderRecentReports(result.recent_reports || []);
         
       } catch (err) {
         console.error('Breakdown load error:', err);
         breakdownContainer.innerHTML = `
           <div class="empty-state">
             <div class="empty-state-icon">‚ö†Ô∏è</div>
             <p>Veriler y√ºklenemedi.</p>
             <button class="btn-refresh" onclick="loadBreakdown()" style="margin-top: 15px;">Tekrar Dene</button>
           </div>
         `;
         recentContainer.innerHTML = `
           <div class="empty-state">
             <div class="empty-state-icon">‚ö†Ô∏è</div>
             <p>Veriler y√ºklenemedi.</p>
           </div>
         `;
         showToast('Detay veriler y√ºklenirken hata olu≈ütu', 'error');
       }
     }

     // Render machine breakdown table
     function renderMachineBreakdown(breakdown) {
       const container = document.getElementById('machine-breakdown-container');
       
       if (!breakdown || breakdown.length === 0) {
         container.innerHTML = `
           <div class="empty-state" style="padding: 40px;">
             <div class="empty-state-icon">üìä</div>
             <p>Makine verisi bulunamadƒ±.</p>
           </div>
         `;
         return;
       }
       
       const table = document.createElement('table');
       table.innerHTML = `
         <thead>
           <tr>
             <th>Makine Adƒ±</th>
             <th>Bildirim Sayƒ±sƒ±</th>
             <th>Son Bildirim Tarihi</th>
           </tr>
         </thead>
         <tbody>
           ${breakdown.map(machine => `
             <tr>
               <td>${machine.makine_adi || '-'}</td>
               <td style="text-align: center; font-weight: 600; color: var(--accent);">${machine.report_count || 0}</td>
               <td>${machine.last_report_at ? formatDate(machine.last_report_at) : '-'}</td>
             </tr>
           `).join('')}
         </tbody>
       `;
       
       container.innerHTML = '';
       container.appendChild(table);
     }

     // Render recent reports list
     function renderRecentReports(reports) {
       const container = document.getElementById('recent-reports-container');
       
       if (!reports || reports.length === 0) {
         container.innerHTML = `
           <div class="empty-state" style="padding: 40px;">
             <div class="empty-state-icon">üìã</div>
             <p>Son bildirim bulunamadƒ±.</p>
           </div>
         `;
         return;
       }
       
       const reportsHTML = reports.map(report => {
         const statusClass = getStatusClass(report.status);
         const priorityClass = getPriorityClass(report.priority);
         const dateStr = formatDate(report.created_at);
         const reportId = `report-${report.report_id}`;
         
         return `
           <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; margin-bottom: 12px; transition: all 0.2s ease;">
             <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; flex-wrap: wrap;">
               <div style="flex: 1; min-width: 200px;">
                 <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; flex-wrap: wrap;">
                   <span style="font-size: 0.85rem; color: var(--text-secondary);">${dateStr}</span>
                   <span class="status-badge ${statusClass}">${report.status}</span>
                   <span class="priority-badge ${priorityClass}">${report.priority}</span>
                 </div>
                 <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 6px;">${report.title || '-'}</div>
                 <div style="font-size: 0.85rem; color: var(--text-secondary);">
                   <span>üë§ ${report.personel_ad_soyad || '-'}</span>
                   <span style="margin: 0 10px;">‚Ä¢</span>
                   <span>‚öôÔ∏è ${report.makine_adi || '-'}</span>
                   <span style="margin: 0 10px;">‚Ä¢</span>
                   <span>üîß ${report.fault_type || '-'}</span>
                 </div>
                 <div id="${reportId}-description" style="display: none; margin-top: 10px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px; font-size: 0.9rem; color: var(--text-secondary); white-space: pre-wrap; word-wrap: break-word;">
                   ${report.description || 'A√ßƒ±klama yok.'}
                 </div>
               </div>
               <div>
                 <button class="btn-detail" onclick="toggleDescription('${reportId}')" style="margin-right: 8px;">
                   <span id="${reportId}-toggle">üìñ A√ßƒ±klama</span>
                 </button>
                 <button class="btn-detail" onclick="showDetailFromRecent(${report.report_id})">
                   Detay
                 </button>
               </div>
             </div>
           </div>
         `;
       }).join('');
       
       container.innerHTML = reportsHTML;
     }

     // Toggle description visibility
     function toggleDescription(reportId) {
       const descEl = document.getElementById(`${reportId}-description`);
       const toggleEl = document.getElementById(`${reportId}-toggle`);
       
       if (descEl.style.display === 'none') {
         descEl.style.display = 'block';
         toggleEl.textContent = 'üìñ Gizle';
       } else {
         descEl.style.display = 'none';
         toggleEl.textContent = 'üìñ A√ßƒ±klama';
       }
     }

     // Show detail from recent reports (fetch full report data)
     function showDetailFromRecent(reportId) {
       // showDetail already handles fetching if report not found
       showDetail(reportId);
     }

    // Show detail modal
    async function showDetail(reportId) {
      let report = allReports.find(r => r.report_id === reportId);
      
      // If not found in current page, try to fetch it
      if (!report) {
        try {
          const res = await fetch(`/api/admin/machine-fault-reports?limit=1000`);
          if (res.ok) {
            const result = await res.json();
            const reports = Array.isArray(result) ? result : (result.data || []);
            report = reports.find(r => r.report_id === reportId);
          }
        } catch (err) {
          console.error('Fetch report error:', err);
        }
      }
      
      if (!report) {
        showToast('Bildirim bulunamadƒ±', 'error');
        return;
      }

      currentReportId = reportId;
      const modalBody = document.getElementById('modal-body');
      const statusSelect = document.getElementById('status-update-select');
      
      statusSelect.value = report.status;
      
      const dateStr = formatDate(report.created_at);
      const updatedStr = report.updated_at ? formatDate(report.updated_at) : '-';
      const statusClass = getStatusClass(report.status);
      const priorityClass = getPriorityClass(report.priority);

      modalBody.innerHTML = `
        <div class="detail-group">
          <div class="detail-label">Ba≈ülƒ±k</div>
          <div class="detail-value">${report.title}</div>
        </div>
        <div class="detail-group">
          <div class="detail-label">A√ßƒ±klama</div>
          <div class="detail-value detail-description">${report.description || '-'}</div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
          <div class="detail-group">
            <div class="detail-label">Makine</div>
            <div class="detail-value">${report.makine_adi || '-'} (${report.makine_turu || '-'})</div>
          </div>
          <div class="detail-group">
            <div class="detail-label">Arƒ±za Tipi</div>
            <div class="detail-value">${report.fault_type}</div>
          </div>
          <div class="detail-group">
            <div class="detail-label">Personel</div>
            <div class="detail-value">${report.personel_adsoyad || '-'}</div>
          </div>
          <div class="detail-group">
            <div class="detail-label">√ñncelik</div>
            <div class="detail-value">
              <span class="priority-badge ${priorityClass}">${report.priority}</span>
            </div>
          </div>
          <div class="detail-group">
            <div class="detail-label">Durum</div>
            <div class="detail-value">
              <span class="status-badge ${statusClass}">${report.status}</span>
            </div>
          </div>
          <div class="detail-group">
            <div class="detail-label">Olu≈üturulma Tarihi</div>
            <div class="detail-value">${dateStr}</div>
          </div>
          <div class="detail-group">
            <div class="detail-label">G√ºncellenme Tarihi</div>
            <div class="detail-value">${updatedStr}</div>
          </div>
        </div>
      `;

      document.getElementById('detail-modal').classList.add('show');
    }

    // Close modal
    function closeModal() {
      document.getElementById('detail-modal').classList.remove('show');
      currentReportId = null;
    }

    // Update status
    async function updateStatus() {
      if (!currentReportId) return;

      const statusSelect = document.getElementById('status-update-select');
      const saveBtn = document.getElementById('btn-save-status');
      const newStatus = statusSelect.value;

      saveBtn.disabled = true;
      saveBtn.textContent = 'Kaydediliyor...';

      try {
        const res = await fetch(`/api/admin/machine-fault-reports/${currentReportId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: newStatus })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Durum g√ºncellenemedi');
        }

        showToast('‚úÖ Durum ba≈üarƒ±yla g√ºncellendi');
        
        // Update local data
        const report = allReports.find(r => r.report_id === currentReportId);
        if (report) {
          report.status = newStatus;
          report.updated_at = new Date().toISOString();
        }
        
        // Reload table
        await loadReports();
        
        // Update modal
        showDetail(currentReportId);
        
      } catch (err) {
        console.error('Status update error:', err);
        showToast(err.message || 'Durum g√ºncellenirken hata olu≈ütu', 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Kaydet';
      }
    }

    // Close modal on outside click
    document.getElementById('detail-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });

    // Filter change handlers (reset to page 1)
    document.getElementById('filter-status').addEventListener('change', () => {
      currentPage = 1;
      loadReports(1);
    });
    document.getElementById('filter-priority').addEventListener('change', () => {
      currentPage = 1;
      loadReports(1);
    });

     // Initialize on page load
     document.addEventListener('DOMContentLoaded', () => {
       loadReports(1);
       loadDistributionChart();
       loadTypeDistributionChart();
       loadPersonnelSummary();
       loadBreakdown();
       
       // Event listeners for filters
       document.getElementById('time-range-select').addEventListener('change', (e) => {
         currentMonths = parseInt(e.target.value, 10);
         loadPersonnelSummary();
         loadBreakdown();
       });
       
       document.getElementById('personnel-select').addEventListener('change', (e) => {
         // Update state immediately from select value
         currentPersonnelId = e.target.value;
         
         // Reload summary to get fresh data and update KPIs
         // Note: loadPersonnelSummary will preserve the selection we just set
         loadPersonnelSummary().then(result => {
           if (result && result.success) {
             // KPIs are already updated in loadPersonnelSummary, but ensure sync
             updateKPIs(result, currentPersonnelId);
           }
         }).catch(err => {
           console.error('Summary reload error:', err);
           // Even if summary fails, try to load breakdown with current selection
           loadBreakdown();
         });
         
         // Load breakdown with new filter (don't wait for summary)
         loadBreakdown();
       });
     });
  </script>
</body>
</html>
