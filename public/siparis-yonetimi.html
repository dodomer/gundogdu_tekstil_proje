<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sipari≈ü Y√∂netimi - G√ºndoƒüdu Tekstil</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0c1222;
      --bg-card: #151d30;
      --border-color: #2a3a5c;
      --accent: #d4a853;
      --accent-light: #f0c970;
      --accent-glow: rgba(212, 168, 83, 0.3);
      --text-primary: #ffffff;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #f59e0b;
      --info: #3b82f6;
      --purple: #8b5cf6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-dark);
      min-height: 100vh;
      color: var(--text-primary);
    }

    .header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-color);
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left { display: flex; align-items: center; gap: 15px; }

    .logo-icon {
      width: 50px; height: 50px;
      background: linear-gradient(135deg, var(--accent), var(--accent-light));
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem;
    }

    .header-title h1 { font-size: 1.3rem; font-weight: 600; }
    .header-title p { font-size: 0.85rem; color: var(--text-secondary); }

    .header-right { display: flex; align-items: center; gap: 15px; }

    .back-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--bg-dark);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }
    .back-btn:hover { border-color: var(--accent); color: var(--accent); }

    .main-content { padding: 30px 40px; max-width: 1400px; margin: 0 auto; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
    }
    .stat-icon { font-size: 1.8rem; margin-bottom: 8px; }
    .stat-value { font-size: 1.8rem; font-weight: 700; color: var(--accent); }
    .stat-label { font-size: 0.8rem; color: var(--text-secondary); }
    .stat-card-iptal { border-color: rgba(239, 68, 68, 0.4); }
    .stat-card-iptal .stat-value { color: var(--danger); }

    .table-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      overflow: hidden;
    }

    .table-header {
      padding: 20px 25px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    .table-header h2 { font-size: 1.1rem; font-weight: 600; }

    .search-wrapper { position: relative; }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5; }
    .search-input {
      padding: 10px 15px 10px 40px;
      background: var(--bg-dark);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9rem;
      width: 280px;
    }
    .search-input:focus { outline: none; border-color: var(--accent); }

    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    thead { background: rgba(212, 168, 83, 0.1); }
    th {
      padding: 14px 16px;
      text-align: left;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
    }
    td {
      padding: 14px 16px;
      font-size: 0.85rem;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-color);
    }
    tbody tr { transition: background 0.2s ease; }
    tbody tr:hover { background: rgba(255, 255, 255, 0.03); }
    tbody tr:last-child td { border-bottom: none; }

    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-planlandi { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
    .status-uretimde { background: rgba(139, 92, 246, 0.2); color: var(--purple); }
    .status-tamamlandi { background: rgba(34, 197, 94, 0.2); color: var(--success); }
    .status-sevk_edildi { background: rgba(59, 130, 246, 0.2); color: var(--info); }
    .status-iptal { background: rgba(239, 68, 68, 0.2); color: var(--danger); }

    .action-btns { display: flex; gap: 8px; }
    .btn-edit, .btn-delete {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s ease;
    }
    .btn-edit { background: rgba(59, 130, 246, 0.2); color: var(--info); }
    .btn-edit:hover { background: rgba(59, 130, 246, 0.4); }
    .btn-delete { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
    .btn-delete:hover { background: rgba(239, 68, 68, 0.4); }

    .loading-state, .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .loading-spinner {
      width: 40px; height: 40px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      width: 90%;
      max-width: 550px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 25px;
      border-bottom: 1px solid var(--border-color);
    }
    .modal-header h3 { font-size: 1.1rem; font-weight: 600; }
    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    .modal-close:hover { color: var(--text-primary); }
    .modal-body { padding: 25px; }
    .form-group { margin-bottom: 18px; }
    .form-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      background: var(--bg-dark);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9rem;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 20px 25px;
      border-top: 1px solid var(--border-color);
    }
    .btn-cancel {
      padding: 10px 20px;
      background: var(--bg-dark);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: inherit;
      cursor: pointer;
    }
    .btn-cancel:hover { border-color: var(--text-secondary); }
    .btn-save {
      padding: 10px 25px;
      background: linear-gradient(135deg, var(--accent), var(--accent-light));
      border: none;
      border-radius: 8px;
      color: var(--bg-dark);
      font-family: inherit;
      font-weight: 600;
      cursor: pointer;
    }
      .btn-save:hover { box-shadow: 0 5px 20px var(--accent-glow); }

      .pagination-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-top: 1px solid var(--border-color);
      }

      .pagination-btn {
        padding: 8px 14px;
        background: var(--bg-dark);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-primary);
        font-family: inherit;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 40px;
      }

      .pagination-btn:hover:not(:disabled) {
        border-color: var(--accent);
        color: var(--accent);
        background: rgba(212, 168, 83, 0.1);
      }

      .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .pagination-btn.active {
        background: linear-gradient(135deg, var(--accent), var(--accent-light));
        border-color: var(--accent);
        color: var(--bg-dark);
        font-weight: 600;
      }

      .pagination-btn.active:hover {
        background: linear-gradient(135deg, var(--accent), var(--accent-light));
        color: var(--bg-dark);
      }

      .pagination-pages {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .loading-row {
        text-align: center;
        padding: 40px;
      }

      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(212, 168, 83, 0.3);
        border-radius: 50%;
        border-top-color: var(--accent);
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

    .dashboard-footer {
      text-align: center;
      padding: 30px;
      color: var(--text-muted);
      font-size: 0.85rem;
    }
    .dashboard-footer a { color: var(--accent); text-decoration: none; }

    @media (max-width: 768px) {
      .header { flex-direction: column; gap: 15px; padding: 20px; }
      .main-content { padding: 20px; }
      .table-header { flex-direction: column; }
      .search-input { width: 100%; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <div class="logo-icon">üì¶</div>
      <div class="header-title">
        <h1>Sipari≈ü Y√∂netimi</h1>
        <p>M√º≈üteri sipari≈ülerini y√∂netin</p>
      </div>
    </div>
    <div class="header-right">
      <a href="/admin-dashboard.html" class="back-btn">‚Üê Admin Paneline D√∂n</a>
    </div>
  </header>

  <main class="main-content">
    <section class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üì¶</div>
        <div class="stat-value" id="totalOrders">--</div>
        <div class="stat-label">Toplam Sipari≈ü</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìã</div>
        <div class="stat-value" id="planlandiOrders">--</div>
        <div class="stat-label">Planlandƒ±</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üîÑ</div>
        <div class="stat-value" id="uretimdeOrders">--</div>
        <div class="stat-label">√úretimde</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-value" id="tamamlandiOrders">--</div>
        <div class="stat-label">Tamamlandƒ±</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üöö</div>
        <div class="stat-value" id="sevkOrders">--</div>
        <div class="stat-label">Sevk Edildi</div>
      </div>
      <div class="stat-card stat-card-iptal">
        <div class="stat-icon">‚ùå</div>
        <div class="stat-value" id="iptalOrders">--</div>
        <div class="stat-label">ƒ∞ptal Edilenler</div>
      </div>
    </section>

    <div class="table-card">
      <div class="table-header">
        <h2>üìã M√º≈üteri Sipari≈üleri</h2>
        <div class="search-wrapper">
          <span class="search-icon">üîç</span>
          <input type="text" class="search-input" id="searchInput" placeholder="M√º≈üteri veya √ºr√ºn ara...">
        </div>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>M√º≈üteri</th>
              <th>√úr√ºnler</th>
              <th>Adet</th>
              <th>Tutar</th>
              <th>Sipari≈ü Tarihi</th>
              <th>Tahmini Teslim Tarihi</th>
              <th>Durum</th>
              <th>Deƒüerlendirme</th>
              <th>ƒ∞≈ülemler</th>
            </tr>
          </thead>
          <tbody id="ordersTableBody">
            <tr>
              <td colspan="9">
                <div class="loading-state">
                  <div class="loading-spinner"></div>
                  <p>Sipari≈üler y√ºkleniyor...</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Pagination Controls -->
      <div class="pagination-wrapper" id="pagination-wrapper" style="display: none;">
        <div style="color: var(--text-secondary); font-size: 0.9rem;">
          Toplam: <strong style="color: var(--text-primary);" id="pagination-total">0</strong> kayƒ±t
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <label style="color: var(--text-secondary); font-size: 0.9rem; margin-right: 8px;">
            Sayfa ba≈üƒ±na:
            <select id="rows-per-page" style="margin-left: 8px; padding: 6px 10px; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-family: inherit; cursor: pointer;">
              <option value="10">10</option>
              <option value="20" selected>20</option>
              <option value="50">50</option>
            </select>
          </label>
          <div style="display: flex; align-items: center; gap: 8px;">
            <button id="pagination-prev" class="pagination-btn" onclick="changePage(paginationState.page - 1)" disabled>
              ‚Üê √ñnceki
            </button>
            <div id="pagination-pages" class="pagination-pages">
              <!-- Page numbers will be inserted here -->
            </div>
            <button id="pagination-next" class="pagination-btn" onclick="changePage(paginationState.page + 1)">
              Sonraki ‚Üí
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Customer Reviews Section -->
    <div class="table-card" id="reviews-section" style="margin-top: 30px;">
      <div class="table-header">
        <h2>‚≠ê M√º≈üteri Deƒüerlendirmeleri</h2>
      </div>
      <div id="reviews-list" style="padding: 20px;">
        <div class="loading-state">
          <div class="spinner"></div>
          <p>Deƒüerlendirmeler y√ºkleniyor...</p>
        </div>
      </div>
      <div id="reviews-pagination" style="display: none; padding: 20px; border-top: 1px solid var(--border-color); text-align: center;">
        <button id="reviews-prev" class="pagination-btn" onclick="changeReviewsPage(reviewsState.page - 1)" disabled>‚Üê √ñnceki</button>
        <span style="margin: 0 16px; color: var(--text-secondary);">Sayfa <strong id="reviews-page-num">1</strong> / <strong id="reviews-total-pages">1</strong></span>
        <button id="reviews-next" class="pagination-btn" onclick="changeReviewsPage(reviewsState.page + 1)">Sonraki ‚Üí</button>
      </div>
    </div>
  </main>

  <footer class="dashboard-footer">
    <p>¬© 2025 G√ºndoƒüdu Tekstil. T√ºm haklarƒ± saklƒ±dƒ±r. | <a href="/admin-dashboard.html">Admin Paneli</a></p>
  </footer>

  <!-- Edit Order Modal -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Sipari≈ü D√ºzenle</h3>
        <button class="modal-close" onclick="closeEditModal()">&times;</button>
      </div>
      <form id="editForm">
        <div class="modal-body">
          <input type="hidden" id="edit_id">
          
          <div class="form-group">
            <label for="edit_durumu">Durum</label>
            <select id="edit_durumu">
              <option value="PLANLANDI">Planlandƒ±</option>
              <option value="URETIMDE">√úretimde</option>
              <option value="TAMAMLANDI">Tamamlandƒ±</option>
              <option value="SEVK_EDILDI">Sevk Edildi</option>
              <option value="IPTAL">ƒ∞ptal</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="edit_teslim_tarihi">Teslim Tarihi</label>
            <input type="date" id="edit_teslim_tarihi">
          </div>
          
          <div class="form-group">
            <label for="edit_musteri_notu">M√º≈üteri Notu</label>
            <textarea 
              id="edit_musteri_notu" 
              readonly 
              disabled
              style="width: 100%; padding: 12px; min-height: 100px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 0.9rem; resize: vertical; color: #333; line-height: 1.5; cursor: not-allowed;"
            ></textarea>
            <small id="edit_musteri_notu_empty" style="display: none; color: #666; font-style: italic; padding: 12px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; display: block;">Bu sipari≈ü i√ßin m√º≈üteri notu bulunmamaktadƒ±r.</small>
          </div>
          
          <div class="form-group">
            <label>M√º≈üteri Deƒüerlendirmesi</label>
            <div id="edit_review_container" style="padding: 12px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; min-height: 60px;">
              <small id="edit_review_empty" style="color: #666; font-style: italic;">Bu sipari≈ü hen√ºz deƒüerlendirilmemi≈ü.</small>
              <div id="edit_review_content" style="display: none;">
                <div style="margin-bottom: 12px;">
                  <span style="font-size: 0.9rem; color: #333; margin-right: 8px;">Puan:</span>
                  <span id="edit_review_stars" style="font-size: 1.2rem;"></span>
                </div>
                <div id="edit_review_yorum_container" style="display: none;">
                  <span style="font-size: 0.9rem; color: #333; margin-right: 8px;">Yorum:</span>
                  <p id="edit_review_yorum" style="font-size: 0.85rem; color: #555; margin-top: 8px; line-height: 1.5; white-space: pre-wrap;"></p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-cancel" onclick="closeEditModal()">ƒ∞ptal</button>
          <button type="submit" class="btn-save">G√ºncelle</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let allOrders = [];
    let paginationState = {
      page: 1,
      limit: 20,
      total: 0,
      totalPages: 0,
      searchTerm: ''
    };
    let searchDebounceTimer = null;
    
    // Reviews state
    let reviewsState = {
      page: 1,
      limit: 10,
      totalPages: 1
    };

    async function loadOrders(page = null, limit = null, searchTerm = null) {
      const tbody = document.getElementById('ordersTableBody');
      
      // Show loading state
      tbody.innerHTML = `
        <tr><td colspan="9">
          <div class="loading-row">
            <div class="spinner"></div>
            <p style="margin-top: 12px; color: var(--text-secondary);">Y√ºkleniyor...</p>
          </div>
        </td></tr>`;
      
      try {
        // Update state
        if (page !== null) paginationState.page = page;
        if (limit !== null) {
          paginationState.limit = limit;
          paginationState.page = 1; // Reset to page 1 when limit changes
        }
        if (searchTerm !== null) {
          paginationState.searchTerm = searchTerm;
          paginationState.page = 1; // Reset to page 1 when search changes
        }
        
        // Build query params
        const params = new URLSearchParams({
          page: paginationState.page,
          limit: paginationState.limit
        });
        if (paginationState.searchTerm) {
          params.append('q', paginationState.searchTerm);
        }
        
        const response = await fetch(`/api/siparisler?${params.toString()}`);
        if (!response.ok) throw new Error('Sunucu hatasƒ±');
        
        const result = await response.json();
        
        if (result.success && result.data) {
          allOrders = result.data.rows;
          paginationState.total = result.data.total;
          paginationState.totalPages = result.data.totalPages;
          
          renderTable(result.data.rows);
          updateStats(result.data.rows);
          updatePaginationUI();
          
          // Update rows per page selector to match current limit
          const rowsPerPageSelect = document.getElementById('rows-per-page');
          if (rowsPerPageSelect) {
            rowsPerPageSelect.value = paginationState.limit;
          }
        } else {
          throw new Error('Ge√ßersiz yanƒ±t formatƒ±');
        }
      } catch (error) {
        console.error('Error loading orders:', error);
        tbody.innerHTML = `
          <tr><td colspan="9">
            <div class="empty-state">
              <p>‚ö†Ô∏è Sipari≈üler y√ºklenirken hata olu≈ütu.</p>
            </div>
          </td></tr>`;
      }
    }

    function updateStats(orders) {
      // Note: Stats are calculated from current page only
      // For accurate stats across all pages, consider a separate /api/siparisler/stats endpoint
      document.getElementById('totalOrders').textContent = paginationState.total || orders.length;
      document.getElementById('planlandiOrders').textContent = orders.filter(o => o.durum === 'PLANLANDI').length;
      document.getElementById('uretimdeOrders').textContent = orders.filter(o => o.durum === 'URETIMDE').length;
      document.getElementById('tamamlandiOrders').textContent = orders.filter(o => o.durum === 'TAMAMLANDI').length;
      document.getElementById('sevkOrders').textContent = orders.filter(o => o.durum === 'SEVK_EDILDI').length;
      document.getElementById('iptalOrders').textContent = orders.filter(o => o.durum === 'IPTAL').length;
    }

    function renderTable(orders) {
      const tbody = document.getElementById('ordersTableBody');
      
      if (orders.length === 0) {
        tbody.innerHTML = `<tr><td colspan="10">
          <div class="empty-state"><p>üì≠ Kayƒ±t bulunamadƒ±.</p></div>
        </td></tr>`;
        return;
      }

      tbody.innerHTML = orders.map(order => {
        const siparisTarihi = order.siparis_tarihi ? new Date(order.siparis_tarihi).toLocaleDateString('tr-TR') : '-';
        const teslimTarihi = order.teslim_tarihi ? new Date(order.teslim_tarihi).toLocaleDateString('tr-TR') : '-';
        const statusClass = (order.durum || '').toLowerCase();
        const statusText = getStatusText(order.durum);
        
        // Bind data from API: urunler, adet, tutar
        // Only show fallback when field is truly null/undefined/empty
        const urunler = order.urunler || '-';
        const adet = Number(order.adet) || 0;
        const tutarNum = Number(order.tutar) || 0;
        const tutar = tutarNum.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' ‚Ç∫';
        const hasNote = order.musteri_notu && order.musteri_notu.trim().length > 0;
        const noteIcon = hasNote ? '<span title="Bu sipari≈üte m√º≈üteri notu var" style="margin-left: 4px; font-size: 0.9rem; cursor: help;">üìù</span>' : '';
        
        // Review display
        const hasReview = order.degerlendirme_puan !== null && order.degerlendirme_puan !== undefined;
        const puan = order.degerlendirme_puan || 0;
        let reviewHtml = '<span style="color: var(--text-secondary);">‚Äî</span>';
        
        if (hasReview && puan > 0) {
          const starsHtml = Array.from({ length: 5 }, (_, i) => {
            const filled = i < puan ? '‚òÖ' : '‚òÜ';
            const color = i < puan ? '#fbbf24' : 'var(--text-secondary)';
            return `<span style="color: ${color}; font-size: 0.9rem;">${filled}</span>`;
          }).join('');
          reviewHtml = `<div style="display: flex; align-items: center; gap: 6px;">
            ${starsHtml}
            <span style="font-size: 0.85rem; color: var(--text-secondary);">${puan}/5</span>
          </div>`;
        }

        return `
          <tr>
            <td><strong>#${order.id}</strong>${noteIcon}</td>
            <td>${order.musteri_adi || '-'}</td>
            <td>${urunler}</td>
            <td>${adet}</td>
            <td>${tutar}</td>
            <td>${siparisTarihi}</td>
            <td>${teslimTarihi}</td>
            <td><span class="status-badge status-${statusClass}">${statusText}</span></td>
            <td>${reviewHtml}</td>
            <td>
              <div class="action-btns">
                <button class="btn-edit" onclick="openEditModal(${order.id})">‚úèÔ∏è</button>
                <button class="btn-delete" onclick="deleteOrder(${order.id})">üóëÔ∏è</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function getStatusText(status) {
      const map = {
        'PLANLANDI': 'Planlandƒ±',
        'URETIMDE': '√úretimde',
        'TAMAMLANDI': 'Tamamlandƒ±',
        'SEVK_EDILDI': 'Sevk Edildi',
        'IPTAL': 'ƒ∞ptal'
      };
      return map[status] || status || '-';
    }

    // Search with debounce
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const term = e.target.value.trim();
      
      // Clear existing timer
      if (searchDebounceTimer) {
        clearTimeout(searchDebounceTimer);
      }
      
      // Debounce: wait 300ms after user stops typing
      searchDebounceTimer = setTimeout(() => {
        loadOrders(null, null, term);
      }, 300);
    });

    // Edit Modal
    function openEditModal(id) {
      const order = allOrders.find(o => o.id === id);
      if (!order) return;
      
      document.getElementById('edit_id').value = id;
      document.getElementById('edit_durumu').value = order.durum || 'PLANLANDI';
      document.getElementById('edit_teslim_tarihi').value = order.teslim_tarihi ? order.teslim_tarihi.split('T')[0] : '';
      
      // Handle customer note
      const noteTextarea = document.getElementById('edit_musteri_notu');
      const noteEmptyMsg = document.getElementById('edit_musteri_notu_empty');
      const hasNote = order.musteri_notu && order.musteri_notu.trim().length > 0;
      
      if (hasNote) {
        noteTextarea.value = order.musteri_notu;
        noteTextarea.style.display = 'block';
        noteEmptyMsg.style.display = 'none';
      } else {
        noteTextarea.value = '';
        noteTextarea.style.display = 'none';
        noteEmptyMsg.style.display = 'block';
      }
      
      // Handle customer review
      const reviewContainer = document.getElementById('edit_review_container');
      const reviewEmpty = document.getElementById('edit_review_empty');
      const reviewContent = document.getElementById('edit_review_content');
      const reviewStars = document.getElementById('edit_review_stars');
      const reviewYorumContainer = document.getElementById('edit_review_yorum_container');
      const reviewYorum = document.getElementById('edit_review_yorum');
      
      const hasReview = order.degerlendirme_puan !== null && order.degerlendirme_puan !== undefined;
      const puan = order.degerlendirme_puan || 0;
      const yorum = order.degerlendirme_yorum || '';
      
      if (hasReview && puan > 0) {
        // Show review
        reviewEmpty.style.display = 'none';
        reviewContent.style.display = 'block';
        
        // Render stars
        const starsHtml = Array.from({ length: 5 }, (_, i) => {
          const filled = i < puan ? '‚òÖ' : '‚òÜ';
          const color = i < puan ? '#fbbf24' : '#ccc';
          return `<span style="color: ${color};">${filled}</span>`;
        }).join('');
        reviewStars.innerHTML = starsHtml;
        
        // Show comment if exists
        if (yorum && yorum.trim().length > 0) {
          reviewYorumContainer.style.display = 'block';
          reviewYorum.textContent = yorum;
        } else {
          reviewYorumContainer.style.display = 'none';
        }
      } else {
        // No review
        reviewEmpty.style.display = 'block';
        reviewContent.style.display = 'none';
      }
      
      document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
    }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = document.getElementById('edit_id').value;
      const data = {
        durumu: document.getElementById('edit_durumu').value,
        teslim_plan: document.getElementById('edit_teslim_tarihi').value || null
      };

      try {
        const response = await fetch(`/api/siparisler/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          closeEditModal();
          loadOrders();
        } else {
          const err = await response.json();
          alert('Hata: ' + (err.error || 'ƒ∞≈ülem ba≈üarƒ±sƒ±z'));
        }
      } catch (error) {
        console.error('Update error:', error);
        alert('Bir hata olu≈ütu.');
      }
    });

    // Delete Order
    async function deleteOrder(id) {
      if (!confirm('Bu sipari≈üi silmek istediƒüinize emin misiniz?')) return;

      try {
        const response = await fetch(`/api/siparisler/${id}`, { method: 'DELETE' });
        if (response.ok) {
          loadOrders();
        } else {
          alert('Silme i≈ülemi ba≈üarƒ±sƒ±z oldu.');
        }
      } catch (error) {
        console.error('Delete error:', error);
        alert('Bir hata olu≈ütu.');
      }
    }

    // Pagination functions
    function changePage(newPage) {
      if (newPage < 1 || newPage > paginationState.totalPages) return;
      loadOrders(newPage, null, null);
    }
    
    function updatePaginationUI() {
      const wrapper = document.getElementById('pagination-wrapper');
      const totalEl = document.getElementById('pagination-total');
      const prevBtn = document.getElementById('pagination-prev');
      const nextBtn = document.getElementById('pagination-next');
      const pagesContainer = document.getElementById('pagination-pages');
      
      // Show pagination if there are multiple pages
      if (wrapper) {
        wrapper.style.display = paginationState.totalPages > 1 ? 'flex' : 'none';
      }
      
      if (totalEl) totalEl.textContent = paginationState.total;
      if (prevBtn) prevBtn.disabled = paginationState.page <= 1;
      if (nextBtn) nextBtn.disabled = paginationState.page >= paginationState.totalPages;
      
      // Render page numbers
      if (pagesContainer) {
        const maxVisible = 5;
        let startPage = Math.max(1, paginationState.page - Math.floor(maxVisible / 2));
        let endPage = Math.min(paginationState.totalPages, startPage + maxVisible - 1);
        
        // Adjust start if we're near the end
        if (endPage - startPage < maxVisible - 1) {
          startPage = Math.max(1, endPage - maxVisible + 1);
        }
        
        let pagesHtml = '';
        
        // First page + ellipsis
        if (startPage > 1) {
          pagesHtml += `<button class="pagination-btn" onclick="changePage(1)">1</button>`;
          if (startPage > 2) {
            pagesHtml += `<span style="color: var(--text-secondary); padding: 0 4px;">...</span>`;
          }
        }
        
        // Page numbers
        for (let i = startPage; i <= endPage; i++) {
          const isActive = i === paginationState.page;
          pagesHtml += `<button class="pagination-btn ${isActive ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
        }
        
        // Ellipsis + last page
        if (endPage < paginationState.totalPages) {
          if (endPage < paginationState.totalPages - 1) {
            pagesHtml += `<span style="color: var(--text-secondary); padding: 0 4px;">...</span>`;
          }
          pagesHtml += `<button class="pagination-btn" onclick="changePage(${paginationState.totalPages})">${paginationState.totalPages}</button>`;
        }
        
        pagesContainer.innerHTML = pagesHtml;
      }
    }
    
    // Rows per page selector
    document.getElementById('rows-per-page').addEventListener('change', (e) => {
      const newLimit = parseInt(e.target.value, 10);
      loadOrders(null, newLimit, null);
    });

    // Load and render reviews from dedicated endpoint
    async function loadReviews() {
      const reviewsList = document.getElementById('reviews-list');
      if (!reviewsList) return;
      
      // Show loading state
      reviewsList.innerHTML = `
        <div class="loading-state">
          <div class="spinner"></div>
          <p>Deƒüerlendirmeler y√ºkleniyor...</p>
        </div>
      `;
      
      try {
        const response = await fetch('/api/admin/customer-reviews');
        if (!response.ok) throw new Error('Sunucu hatasƒ±');
        
        const result = await response.json();
        console.log('[loadReviews] API response:', result);
        
        if (!result.success) {
          throw new Error(result.error || 'Deƒüerlendirmeler y√ºklenemedi');
        }
        
        const reviews = result.reviews || [];
        console.log('[loadReviews] Reviews found:', reviews.length);
        
        if (reviews.length === 0) {
          reviewsList.innerHTML = `
            <div class="empty-state">
              <p>Hen√ºz m√º≈üteri deƒüerlendirmesi bulunmamaktadƒ±r.</p>
            </div>
          `;
          const paginationEl = document.getElementById('reviews-pagination');
          if (paginationEl) paginationEl.style.display = 'none';
          return;
        }
        
        // Paginate reviews
        reviewsState.totalPages = Math.ceil(reviews.length / reviewsState.limit);
        const startIdx = (reviewsState.page - 1) * reviewsState.limit;
        const endIdx = startIdx + reviewsState.limit;
        const paginatedReviews = reviews.slice(startIdx, endIdx);
        
        // Render reviews
        reviewsList.innerHTML = paginatedReviews.map(review => {
          const puan = review.puan || 0;
          const yorum = review.yorum || '';
          const olusturmaTarihi = review.olusturma_tarihi ? new Date(review.olusturma_tarihi).toLocaleDateString('tr-TR') : '-';
          const musteriAdi = review.musteri_adsoyad || review.musteri_adi || 'Bilinmeyen M√º≈üteri';
          const siparisId = review.siparis_id || review.id || '-';
          
          // Escape HTML in comment
          const escapedYorum = yorum
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
          
          const starsHtml = Array.from({ length: 5 }, (_, i) => {
            const filled = i < puan ? '‚òÖ' : '‚òÜ';
            const color = i < puan ? '#fbbf24' : 'var(--text-secondary)';
            return `<span style="color: ${color}; font-size: 1.1rem;">${filled}</span>`;
          }).join('');
          
          return `
            <div class="review-card" style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div>
                  <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                    Sipari≈ü #${siparisId} - ${musteriAdi}
                  </div>
                  <div style="font-size: 0.85rem; color: var(--text-secondary);">
                    üìÖ ${olusturmaTarihi}
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  ${starsHtml}
                  <span style="font-size: 0.9rem; color: var(--text-secondary); font-weight: 600;">${puan}/5</span>
                </div>
              </div>
              ${yorum ? `
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                  <p style="color: var(--text-primary); line-height: 1.6; white-space: pre-wrap;">${escapedYorum}</p>
                </div>
              ` : ''}
            </div>
          `;
        }).join('');
        
        // Update pagination UI
        updateReviewsPaginationUI(reviews.length);
      } catch (error) {
        console.error('[loadReviews] Error:', error);
        reviewsList.innerHTML = `
          <div class="empty-state">
            <p style="color: #ef4444;">Deƒüerlendirmeler y√ºklenirken hata olu≈ütu: ${error.message || 'Bilinmeyen hata'}</p>
          </div>
        `;
        const paginationEl = document.getElementById('reviews-pagination');
        if (paginationEl) paginationEl.style.display = 'none';
      }
    }
    
    function changeReviewsPage(newPage) {
      if (newPage < 1 || newPage > reviewsState.totalPages) return;
      reviewsState.page = newPage;
      loadReviews();
    }
    
    function updateReviewsPaginationUI(totalReviews) {
      const paginationEl = document.getElementById('reviews-pagination');
      const prevBtn = document.getElementById('reviews-prev');
      const nextBtn = document.getElementById('reviews-next');
      const pageNum = document.getElementById('reviews-page-num');
      const totalPages = document.getElementById('reviews-total-pages');
      
      if (!paginationEl) return;
      
      if (reviewsState.totalPages <= 1) {
        paginationEl.style.display = 'none';
        return;
      }
      
      paginationEl.style.display = 'block';
      if (prevBtn) prevBtn.disabled = reviewsState.page <= 1;
      if (nextBtn) nextBtn.disabled = reviewsState.page >= reviewsState.totalPages;
      if (pageNum) pageNum.textContent = reviewsState.page;
      if (totalPages) totalPages.textContent = reviewsState.totalPages;
    }

    // Initialize
    loadOrders();
    loadReviews(); // Load reviews independently
  </script>
</body>
</html>

