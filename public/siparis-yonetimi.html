<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sipari≈ü Y√∂netimi - G√ºndoƒüdu Tekstil</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0c1222;
      --bg-card: #151d30;
      --border-color: #2a3a5c;
      --accent: #d4a853;
      --accent-light: #f0c970;
      --accent-glow: rgba(212, 168, 83, 0.3);
      --text-primary: #ffffff;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #f59e0b;
      --info: #3b82f6;
      --purple: #8b5cf6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-dark);
      min-height: 100vh;
      color: var(--text-primary);
    }

    .header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-color);
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left { display: flex; align-items: center; gap: 15px; }

    .logo-icon {
      width: 50px; height: 50px;
      background: linear-gradient(135deg, var(--accent), var(--accent-light));
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem;
    }

    .header-title h1 { font-size: 1.3rem; font-weight: 600; }
    .header-title p { font-size: 0.85rem; color: var(--text-secondary); }

    .header-right { display: flex; align-items: center; gap: 15px; }

    .back-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--bg-dark);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }
    .back-btn:hover { border-color: var(--accent); color: var(--accent); }

    .main-content { padding: 30px 40px; max-width: 1400px; margin: 0 auto; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
    }
    .stat-icon { font-size: 1.8rem; margin-bottom: 8px; }
    .stat-value { font-size: 1.8rem; font-weight: 700; color: var(--accent); }
    .stat-label { font-size: 0.8rem; color: var(--text-secondary); }
    .stat-card-iptal { border-color: rgba(239, 68, 68, 0.4); }
    .stat-card-iptal .stat-value { color: var(--danger); }

    .table-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      overflow: hidden;
    }

    .table-header {
      padding: 20px 25px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    .table-header h2 { font-size: 1.1rem; font-weight: 600; }

    .search-wrapper { position: relative; }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5; }
    .search-input {
      padding: 10px 15px 10px 40px;
      background: var(--bg-dark);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9rem;
      width: 280px;
    }
    .search-input:focus { outline: none; border-color: var(--accent); }

    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    thead { background: rgba(212, 168, 83, 0.1); }
    th {
      padding: 14px 16px;
      text-align: left;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
    }
    td {
      padding: 14px 16px;
      font-size: 0.85rem;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-color);
    }
    tbody tr { transition: background 0.2s ease; }
    tbody tr:hover { background: rgba(255, 255, 255, 0.03); }
    tbody tr:last-child td { border-bottom: none; }

    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-planlandi { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
    .status-uretimde { background: rgba(139, 92, 246, 0.2); color: var(--purple); }
    .status-tamamlandi { background: rgba(34, 197, 94, 0.2); color: var(--success); }
    .status-sevk_edildi { background: rgba(59, 130, 246, 0.2); color: var(--info); }
    .status-iptal { background: rgba(239, 68, 68, 0.2); color: var(--danger); }

    .action-btns { display: flex; gap: 8px; }
    .btn-edit, .btn-delete {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s ease;
    }
    .btn-edit { background: rgba(59, 130, 246, 0.2); color: var(--info); }
    .btn-edit:hover { background: rgba(59, 130, 246, 0.4); }
    .btn-delete { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
    .btn-delete:hover { background: rgba(239, 68, 68, 0.4); }

    .loading-state, .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .loading-spinner {
      width: 40px; height: 40px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      width: 90%;
      max-width: 550px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 25px;
      border-bottom: 1px solid var(--border-color);
    }
    .modal-header h3 { font-size: 1.1rem; font-weight: 600; }
    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    .modal-close:hover { color: var(--text-primary); }
    .modal-body { padding: 25px; }
    .form-group { margin-bottom: 18px; }
    .form-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      background: var(--bg-dark);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9rem;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 20px 25px;
      border-top: 1px solid var(--border-color);
    }
    .btn-cancel {
      padding: 10px 20px;
      background: var(--bg-dark);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: inherit;
      cursor: pointer;
    }
    .btn-cancel:hover { border-color: var(--text-secondary); }
    .btn-save {
      padding: 10px 25px;
      background: linear-gradient(135deg, var(--accent), var(--accent-light));
      border: none;
      border-radius: 8px;
      color: var(--bg-dark);
      font-family: inherit;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-save:hover { box-shadow: 0 5px 20px var(--accent-glow); }

    .dashboard-footer {
      text-align: center;
      padding: 30px;
      color: var(--text-muted);
      font-size: 0.85rem;
    }
    .dashboard-footer a { color: var(--accent); text-decoration: none; }

    @media (max-width: 768px) {
      .header { flex-direction: column; gap: 15px; padding: 20px; }
      .main-content { padding: 20px; }
      .table-header { flex-direction: column; }
      .search-input { width: 100%; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <div class="logo-icon">üì¶</div>
      <div class="header-title">
        <h1>Sipari≈ü Y√∂netimi</h1>
        <p>M√º≈üteri sipari≈ülerini y√∂netin</p>
      </div>
    </div>
    <div class="header-right">
      <a href="/admin-dashboard.html" class="back-btn">‚Üê Admin Paneline D√∂n</a>
    </div>
  </header>

  <main class="main-content">
    <section class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üì¶</div>
        <div class="stat-value" id="totalOrders">--</div>
        <div class="stat-label">Toplam Sipari≈ü</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìã</div>
        <div class="stat-value" id="planlandiOrders">--</div>
        <div class="stat-label">Planlandƒ±</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üîÑ</div>
        <div class="stat-value" id="uretimdeOrders">--</div>
        <div class="stat-label">√úretimde</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-value" id="tamamlandiOrders">--</div>
        <div class="stat-label">Tamamlandƒ±</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üöö</div>
        <div class="stat-value" id="sevkOrders">--</div>
        <div class="stat-label">Sevk Edildi</div>
      </div>
      <div class="stat-card stat-card-iptal">
        <div class="stat-icon">‚ùå</div>
        <div class="stat-value" id="iptalOrders">--</div>
        <div class="stat-label">ƒ∞ptal Edilenler</div>
      </div>
    </section>

    <div class="table-card">
      <div class="table-header">
        <h2>üìã M√º≈üteri Sipari≈üleri</h2>
        <div class="search-wrapper">
          <span class="search-icon">üîç</span>
          <input type="text" class="search-input" id="searchInput" placeholder="M√º≈üteri veya √ºr√ºn ara...">
        </div>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>M√º≈üteri</th>
              <th>√úr√ºnler</th>
              <th>Adet</th>
              <th>Tutar</th>
              <th>Sipari≈ü Tarihi</th>
              <th>Tahmini Teslim Tarihi</th>
              <th>Durum</th>
              <th>ƒ∞≈ülemler</th>
            </tr>
          </thead>
          <tbody id="ordersTableBody">
            <tr>
              <td colspan="9">
                <div class="loading-state">
                  <div class="loading-spinner"></div>
                  <p>Sipari≈üler y√ºkleniyor...</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <footer class="dashboard-footer">
    <p>¬© 2025 G√ºndoƒüdu Tekstil. T√ºm haklarƒ± saklƒ±dƒ±r. | <a href="/admin-dashboard.html">Admin Paneli</a></p>
  </footer>

  <!-- Edit Order Modal -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Sipari≈ü D√ºzenle</h3>
        <button class="modal-close" onclick="closeEditModal()">&times;</button>
      </div>
      <form id="editForm">
        <div class="modal-body">
          <input type="hidden" id="edit_id">
          
          <div class="form-group">
            <label for="edit_durumu">Durum</label>
            <select id="edit_durumu">
              <option value="PLANLANDI">Planlandƒ±</option>
              <option value="URETIMDE">√úretimde</option>
              <option value="TAMAMLANDI">Tamamlandƒ±</option>
              <option value="SEVK_EDILDI">Sevk Edildi</option>
              <option value="IPTAL">ƒ∞ptal</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="edit_teslim_tarihi">Teslim Tarihi</label>
            <input type="date" id="edit_teslim_tarihi">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-cancel" onclick="closeEditModal()">ƒ∞ptal</button>
          <button type="submit" class="btn-save">G√ºncelle</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let allOrders = [];

    async function loadOrders() {
      try {
        const response = await fetch('/api/siparisler');
        if (!response.ok) throw new Error('Sunucu hatasƒ±');
        
        const data = await response.json();
        if (Array.isArray(data)) {
          allOrders = data;
          renderTable(data);
          updateStats(data);
        }
      } catch (error) {
        console.error('Error loading orders:', error);
        document.getElementById('ordersTableBody').innerHTML = `
          <tr><td colspan="9">
            <div class="empty-state">
              <p>‚ö†Ô∏è Sipari≈üler y√ºklenirken hata olu≈ütu.</p>
            </div>
          </td></tr>`;
      }
    }

    function updateStats(orders) {
      document.getElementById('totalOrders').textContent = orders.length;
      document.getElementById('planlandiOrders').textContent = orders.filter(o => o.durum === 'PLANLANDI').length;
      document.getElementById('uretimdeOrders').textContent = orders.filter(o => o.durum === 'URETIMDE').length;
      document.getElementById('tamamlandiOrders').textContent = orders.filter(o => o.durum === 'TAMAMLANDI').length;
      document.getElementById('sevkOrders').textContent = orders.filter(o => o.durum === 'SEVK_EDILDI').length;
      document.getElementById('iptalOrders').textContent = orders.filter(o => o.durum === 'IPTAL').length;
    }

    function renderTable(orders) {
      const tbody = document.getElementById('ordersTableBody');
      
      if (orders.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9">
          <div class="empty-state"><p>üì≠ Hen√ºz sipari≈ü bulunmuyor.</p></div>
        </td></tr>`;
        return;
      }

      tbody.innerHTML = orders.map(order => {
        const siparisTarihi = order.siparis_tarihi ? new Date(order.siparis_tarihi).toLocaleDateString('tr-TR') : '-';
        const teslimTarihi = order.teslim_tarihi ? new Date(order.teslim_tarihi).toLocaleDateString('tr-TR') : '-';
        const statusClass = (order.durum || '').toLowerCase();
        const statusText = getStatusText(order.durum);
        
        // Bind data from API: urunler, adet, tutar
        // Only show fallback when field is truly null/undefined/empty
        const urunler = order.urunler || '-';
        const adet = Number(order.adet) || 0;
        const tutarNum = Number(order.tutar) || 0;
        const tutar = tutarNum.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' ‚Ç∫';

        return `
          <tr>
            <td><strong>#${order.id}</strong></td>
            <td>${order.musteri_adi || '-'}</td>
            <td>${urunler}</td>
            <td>${adet}</td>
            <td>${tutar}</td>
            <td>${siparisTarihi}</td>
            <td>${teslimTarihi}</td>
            <td><span class="status-badge status-${statusClass}">${statusText}</span></td>
            <td>
              <div class="action-btns">
                <button class="btn-edit" onclick="openEditModal(${order.id})">‚úèÔ∏è</button>
                <button class="btn-delete" onclick="deleteOrder(${order.id})">üóëÔ∏è</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function getStatusText(status) {
      const map = {
        'PLANLANDI': 'Planlandƒ±',
        'URETIMDE': '√úretimde',
        'TAMAMLANDI': 'Tamamlandƒ±',
        'SEVK_EDILDI': 'Sevk Edildi',
        'IPTAL': 'ƒ∞ptal'
      };
      return map[status] || status || '-';
    }

    // Search
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase().trim();
      if (term === '') {
        renderTable(allOrders);
        return;
      }
      const filtered = allOrders.filter(o => 
        (o.musteri_adi || '').toLowerCase().includes(term) ||
        (o.urunler || '').toLowerCase().includes(term)
      );
      renderTable(filtered);
    });

    // Edit Modal
    function openEditModal(id) {
      const order = allOrders.find(o => o.id === id);
      if (!order) return;
      
      document.getElementById('edit_id').value = id;
      document.getElementById('edit_durumu').value = order.durum || 'PLANLANDI';
      document.getElementById('edit_teslim_tarihi').value = order.teslim_tarihi ? order.teslim_tarihi.split('T')[0] : '';
      document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
    }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = document.getElementById('edit_id').value;
      const data = {
        durumu: document.getElementById('edit_durumu').value,
        teslim_plan: document.getElementById('edit_teslim_tarihi').value || null
      };

      try {
        const response = await fetch(`/api/siparisler/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          closeEditModal();
          loadOrders();
        } else {
          const err = await response.json();
          alert('Hata: ' + (err.error || 'ƒ∞≈ülem ba≈üarƒ±sƒ±z'));
        }
      } catch (error) {
        console.error('Update error:', error);
        alert('Bir hata olu≈ütu.');
      }
    });

    // Delete Order
    async function deleteOrder(id) {
      if (!confirm('Bu sipari≈üi silmek istediƒüinize emin misiniz?')) return;

      try {
        const response = await fetch(`/api/siparisler/${id}`, { method: 'DELETE' });
        if (response.ok) {
          loadOrders();
        } else {
          alert('Silme i≈ülemi ba≈üarƒ±sƒ±z oldu.');
        }
      } catch (error) {
        console.error('Delete error:', error);
        alert('Bir hata olu≈ütu.');
      }
    }

    // Initialize
    loadOrders();
  </script>
</body>
</html>

