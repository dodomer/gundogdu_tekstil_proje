<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hammadde Stok Takibi - G√ºndoƒüdu Tekstil</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0c1222;
      --bg-card: #151d30;
      --border-color: #2a3a5c;
      --accent: #4a90d9;
      --accent-light: #6ba5e7;
      --accent-glow: rgba(74, 144, 217, 0.3);
      --text-primary: #ffffff;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --danger: #ef4444;
      --warning: #f59e0b;
      --success: #22c55e;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
    }

    .header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-color);
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left { display: flex; align-items: center; gap: 15px; }
    .logo-icon {
      width: 50px; height: 50px;
      background: linear-gradient(135deg, var(--accent), var(--accent-light));
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem;
    }
    .header-title h1 { font-size: 1.3rem; font-weight: 600; }
    .header-title p { font-size: 0.85rem; color: var(--text-secondary); }
    .back-btn {
      padding: 10px 20px;
      background: var(--bg-dark);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .back-btn:hover { border-color: var(--accent); color: var(--accent); }

    .main-content {
      padding: 30px 40px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .page-title {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .page-title h2 { font-size: 1.4rem; }
    .page-title p { color: var(--text-secondary); }

    .banner {
      padding: 14px 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
      background: var(--bg-card);
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .banner.warning { border-color: rgba(239,68,68,0.5); background: rgba(239,68,68,0.08); }
    .banner.info { background: rgba(74,144,217,0.08); }
    .banner strong { color: var(--text-primary); }
    .banner span.icon { font-size: 1.2rem; }

    .table-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      overflow: hidden;
    }
    table { width: 100%; border-collapse: collapse; }
    thead { background: rgba(74, 144, 217, 0.1); }
    th {
      padding: 14px 16px;
      text-align: left;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--accent);
      letter-spacing: 0.4px;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
    }
    td {
      padding: 12px 16px;
      font-size: 0.95rem;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-color);
    }
    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover { background: rgba(255,255,255,0.03); }
    tbody tr.critical { background: rgba(239,68,68,0.07); }

    .badge {
      padding: 6px 12px;
      border-radius: 9999px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
    }
    .badge-critical { background: rgba(239,68,68,0.2); color: #fca5a5; border: 1px solid rgba(239,68,68,0.5); }
    .badge-normal { background: rgba(34,197,94,0.2); color: #bbf7d0; border: 1px solid rgba(34,197,94,0.4); }

    .loading, .error, .empty {
      text-align: center;
      padding: 40px 16px;
      color: var(--text-muted);
    }
    .loading .spinner {
      width: 36px; height: 36px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .actions {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 12px;
      gap: 10px;
    }
    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background: var(--bg-card);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }
    .btn:hover { border-color: var(--accent); color: var(--accent); }

    @media (max-width: 768px) {
      .header { padding: 20px; flex-direction: column; gap: 12px; }
      .main-content { padding: 20px; }
      th, td { padding: 10px 12px; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <div class="logo-icon">üè≠</div>
      <div class="header-title">
        <h1>Hammadde Stok Takibi</h1>
        <p>Depodaki hammadde stok seviyelerini takip edin</p>
      </div>
    </div>
    <a class="back-btn" href="/factory-dashboard.html">‚Üê Fabrika Paneline D√∂n</a>
  </header>

  <main class="main-content">
    <div class="page-title">
      <span class="logo-icon" style="width:42px; height:42px; font-size:1.2rem;">üì¶</span>
      <div>
        <h2>Hammadde Stok Durumu</h2>
        <p>Mevcut stok, minimum seviyeler ve kritik durumlarƒ± g√∂r√ºnt√ºleyin.</p>
      </div>
    </div>

    <div id="banner-container"></div>

    <div class="actions">
      <button class="btn" id="refreshBtn">‚Üª Yenile</button>
    </div>

    <div class="table-card">
      <table>
        <thead>
          <tr>
            <th>Hammadde</th>
            <th>Mevcut Miktar</th>
            <th>Minimum Miktar</th>
            <th>Durum</th>
          </tr>
        </thead>
        <tbody id="stok-tbody">
          <tr>
            <td colspan="4">
              <div class="loading">
                <div class="spinner"></div>
                <p>Stok verileri y√ºkleniyor...</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <script>
    let stokData = [];

    function renderBanner() {
      const bannerContainer = document.getElementById('banner-container');
      const hasCritical = stokData.some(item => item.kritik);

      if (hasCritical) {
        bannerContainer.innerHTML = `
          <div class="banner warning">
            <span class="icon">‚ö†Ô∏è</span>
            <div>
              <strong>Kritik Stok Uyarƒ±sƒ±</strong>
              <p>A≈üaƒüƒ±daki hammaddelerin stok seviyeleri minimum miktarƒ±n altƒ±nda veya e≈üit durumda.</p>
            </div>
          </div>
        `;
      } else {
        bannerContainer.innerHTML = `
          <div class="banner info">
            <span class="icon">‚ÑπÔ∏è</span>
            <div>
              <strong>Stoklar G√ºvenli</strong>
              <p>T√ºm hammadde stoklarƒ± g√ºvenli seviyede.</p>
            </div>
          </div>
        `;
      }
    }

    function renderTable() {
      const tbody = document.getElementById('stok-tbody');

      if (!stokData || stokData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4">
              <div class="empty">
                <p>Stok bilgisi bulunamadƒ±.</p>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = stokData.map(item => {
        const isCritical = item.kritik;
        const badge = isCritical 
          ? '<span class="badge badge-critical">Kritik Stok</span>'
          : '<span class="badge badge-normal">Normal</span>';

        const birim = item.birim ? ` ${item.birim}` : '';

        return `
          <tr class="${isCritical ? 'critical' : ''}">
            <td>${item.ad || '-'}</td>
            <td>${Number(item.mevcut_miktar).toLocaleString('tr-TR')}${birim}</td>
            <td>${Number(item.min_miktar).toLocaleString('tr-TR')}${birim}</td>
            <td>${badge}</td>
          </tr>
        `;
      }).join('');
    }

    async function loadStock() {
      const tbody = document.getElementById('stok-tbody');
      tbody.innerHTML = `
        <tr>
          <td colspan="4">
            <div class="loading">
              <div class="spinner"></div>
              <p>Stok verileri y√ºkleniyor...</p>
            </div>
          </td>
        </tr>
      `;

      try {
        const response = await fetch('/api/fabrika/hammadde-stok');
        if (!response.ok) throw new Error('Sunucu hatasƒ±');
        const data = await response.json();

        if (!Array.isArray(data)) {
          stokData = [];
        } else {
          stokData = data.map(item => ({
            ...item,
            mevcut_miktar: Math.max(0, Number(item.mevcut_miktar) || 0),
            min_miktar: Math.max(0, Number(item.min_miktar) || 0),
            kritik: Number(item.mevcut_miktar) <= Number(item.min_miktar)
          }));
        }

        renderBanner();
        renderTable();
      } catch (error) {
        console.error('Stok y√ºklenirken hata:', error);
        tbody.innerHTML = `
          <tr>
            <td colspan="4">
              <div class="error">
                <p>Stok verileri alƒ±nƒ±rken bir hata olu≈ütu. L√ºtfen daha sonra tekrar deneyin.</p>
              </div>
            </td>
          </tr>
        `;
        document.getElementById('banner-container').innerHTML = '';
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', loadStock);

    // Init
    loadStock();
  </script>
</body>
</html>

